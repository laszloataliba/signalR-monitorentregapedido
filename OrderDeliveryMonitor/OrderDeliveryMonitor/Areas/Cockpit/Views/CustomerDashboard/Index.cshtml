@model IEnumerable<Order>

@{
    Layout = "~/Views/Shared/_CrudIndex.cshtml";
}

@section indexBody {

    <div id="customerDashboardContainer" style="display: flex; flex-direction: row; background-color: gray; width: 100%; position: relative; position: absolute; left: 0px; top: 0px; bottom: 0px;">

        <div id="AwaitingContainer" style="display: flex; flex-direction: column;">
            @await Html.PartialAsync(AppUtilities.AWAITING_CONTAINER, Model.Where(o => o.Process == EOrderProcess.Awaiting))
        </div>
        <div id="PreparingContainer" style="display: flex; flex-direction: column;">
            @await Html.PartialAsync(AppUtilities.PREPARING_CONTAINER, Model.Where(o => o.Process == EOrderProcess.Preparing))
        </div>
        <div id="FinishedContainer" style="display: flex; flex-direction: column;">
            @await Html.PartialAsync(AppUtilities.FINISHED_CONTAINER, Model.Where(o => o.Process == EOrderProcess.Finished))
        </div>

    </div>

    <script type="text/javascript">
        //Campinho da publicação WebAPI contendo o HUB.
        const signalRconn = SigalRConnection('http://localhost:55317/OrderDeliveryMonitorHub');

        signalRconn.on('@AppUtilities.LOAD_AWAITING_CONTAINER_FOR_CUSTOMERS', function (pOrders, pOrderId, pCommand) {

            if (pOrderId) {
                let $ticket = document.getElementById(`tck${pOrderId}`);
                let $class = pCommand === '@EOrderCommand.Sent' ? 'sent' : 'dragged';

                $ticket.classList.add($class);
            }

            MountContainer(pOrders, '@AppUtilities.AWAITING_CONTAINER');
        });

        signalRconn.on('@AppUtilities.LOAD_PREPARING_CONTAINER_FOR_CUSTOMERS', function (pOrders, pOrderId, pCommand) {

            if (pOrderId) {
                let $ticket = document.getElementById(`tck${pOrderId}`);
                let $class = pCommand === '@EOrderCommand.Sent' ? 'sent' : 'dragged';

                $ticket.classList.add($class);
            }

            MountContainer(pOrders, '@AppUtilities.PREPARING_CONTAINER');
        });

        signalRconn.on('@AppUtilities.LOAD_FINISHED_CONTAINER_FOR_CUSTOMER', function (pOrders, pOrderId) {

            if (pOrderId) {
                let $ticket = document.getElementById(`tck${pOrderId}`);
                let $class = 'dragged';

                $ticket.classList.add($class);
            }

            MountContainer(pOrders, '@AppUtilities.FINISHED_CONTAINER');
        });

        function MountContainer(pOrders, baseContainer) {
            let container = document.getElementById(baseContainer);
            let textHtml = '';

            Array.from(pOrders).forEach(order => {
                textHtml += order.customerTicketLayout;
            });

            container.innerHTML = textHtml;
        }

    </script>
}



